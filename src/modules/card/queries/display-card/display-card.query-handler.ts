import { QueryHandler } from '@nestjs/cqrs'
import { Baas } from '../../../../infrastructure/baas/baas'
import { QueryHandlerBase } from '../../../../libs/ddd/domain/base-classes/query-handler.base'
import { Result } from '../../../../libs/ddd/domain/utils/result.util'
import { NotFoundException } from '../../../../libs/exceptions/index'
import { CardRepository } from '../../database/card/card.repository'
import { LockStatus } from '../../domain/entities/card.types'
import {
  CardNotFoundError,
  CardNotUnlockedError,
} from '../../errors/card.errors'
import { DisplayCardQuery } from './display-card.query'

@QueryHandler(DisplayCardQuery)
export class DisplayCardQueryHandler extends QueryHandlerBase {
  constructor(
    private readonly baas: Baas,
    private readonly cardRepo: CardRepository,
  ) {
    super()
  }

  emptyCardImage =
    'iVBORw0KGgoAAAANSUhEUgAAAUUAAADOCAYAAACpdBDyAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAC8ZSURBVHhe7Z0JmFTlme/fWnqt3ptuutn3HURRwAVFAfcFUECMURMTE+8kZjI3yUwmZibJeGeMJjcmE70xybhE4srqgoI74sIOguxrQy/Q0PtW1bXc9/+dqvbQdDddTRdq9//Hc+iqU+ec7zv1POdX77c7Qoq0QiAYlMMlR+VYWblU1tRIg88nONzhcISPIISQLy8RXyXGx0taikd6ZmdJ39xccblc4SNOpUUpBoMh2bBjpxSUlJj3LqdTnLoBCpEQ8lUiorigBnkI9EAfFePEsaPEof+ac4oUSysqZNWGTUZ+brUpJUgI6UpAef5AwLyecu54ycnMMK8jnCTFPYePyEaNEJMSEihDQkiXJqjqa/B6ZcLI4TKkb9/wXhGrTKwcryhXIe6iEAkh3QKneg6+27hztxwvrwjvDUsRweL7G7boAfEUIiGk2wDfJcTHy6pNm03kCIwU1362XT9kIwohpPuBiBGgpAycaJEpPFpqGlUIIaQ7Av8dKimRQCAgzoKjRyWk/xglEkK6K8Z/WnwuLD0uzmNlFaYfIiGEdGfgweLjKsWqmmpxUIqEkG4OPFhVUyfOeq+vhT7dhBDSvYAHG3xecaI7DusTCSGdTaLbLZmJiWZLT0gI7/3yAg8aH778/genjH0mhJAzAUJcuGOHLN6xWxLcLnFqHLZg1o1S6fWGj/jywspEQkin49Koq7y+QY6Xl0theYUc1i3uK9J2QSkSQmKC6RQNEaIPtOuroxpKkZAvCEgjQYXhiYuT1Ph4s+E19iHSipbWrpeI4msHrtcayJtbZYetrat2dlsF0kWx3H5/yfo6/jT5iBbWKRJylkExMkUf6OKaGtly9JjsPlEmpXV1ZuxtdlKSjOyRLWN75kqf1FSp8fmkMTwHYGtAeBBERUODbCgukd1lZXK0plb85nqJMiQzUyb17iU9UzxS5fU1jfFtDcgnzdYwUuX1SkDPgVwhpSNV1VKuaUFFOZ5kI+LIFXFuRmKieOLj5D8++FAWfbpNRM9B2+6uf7hHjut9Ngf3h3y1Br4viPBIdbWsLSyS/RUVUtngNaNQ8jweGZ+XK+fl5Zljaxsbzd8zgVIk5CwC2ew+cUJ+t2ad7FCBCeb104dewyrrAAgLEtR9w/RB/6cLJ8qI7KxWpZGkwqn3++U3H6+RVfsPiOjrk6+nW9BK4/z+/eTfLr3ESMwbnk+wOZBaocrnByveMiJCun+beb0MyEiXl3ftkcc2bJSK6hor3/6AXDJyuPxq6qVG3ji3rKFevr5wmXhUxrVoVInkQ0lJiJdA8GTd+PVeB2VkyGPXXSW1vlOFBtnvLS+Xhz/6RHaXHMV8X+H7Cx+A70vz4lI53n3OOPna2NEmL5B4R6EUCTkL4BnOVFFAXks3fSqikZSpa4tIEH/xJDr1yIjUIB6NfOacd6780+QLNMqqb4rIAAS7uuCw3P/m29b5iMjCkjB/Aa6FdHA9RFF6zN9nz5QszUtLESiKxAWVlfLdRUs0jxotqoR6qhBzkpNl26FDIoggcU2gAp4yaJBKcYpU26X49xfU1klWmhEpmvuz5z6M5rVPVpY8M+sGqW4mfuTxr5u2yFMfr7W+L6SLe2u6P7026ioj96cS7p2bK/9zw7Vmhu2OipFSJCTGQAupGiXd98Zb8inEosVLg0rAkZgg5/TsKf3T0yReH+6DFZWyrbRU6rVoLRolmYe9vkEmDR0iD6h8EBUCRHtvHTgoD0OIKiyDiilHBXPFgP4yQK+Hc3dpVLpy/0Gpi1wvEBSninHF1+ZJg16r+cMPKR6uqpTvLH758/Qj0sZriBWvIUdM0DpggPxmxhVNUkQ1wF1PPmNJMU4lrdGmAefofZyCRrEZ2dmyeN7NUmOTYoZe//dr18mijZuta+G+Nd83jRgmk3v3kqzEJPGpHD8rPS4vbt8hZSpyk1/NX8+sDHlu1kyNPH2n3F97oBQJiTEZKr4HP/xElm/7zJIJJKMP+b0XTZYbhw019W8oRsIbqD/D65VaFH5w1WpLRKC+Xh6dM1sGatTm1+gNUnxm6zZZoMVwIwM99/4rLpMZAwdohBQ0x2BnnBNLiog89NEaWf7ZdutYldldEy+Q28eNkbpmdXAtShEZ0+NSPCny3QnjZUJ+nmngQBEcYs1SaX1eTxmSMpUf6kwXaP6WbtM0EcHqT8Mrt95i6j3t4CzUiaIeMnIN1FuuKyySn732hgpfhajF6nF9+8iD06Zqum5NM2COxTcTp99Dom6//WStLNmyVb9f6/5uO3+CfOvccVqUjr6OMRwHE0JiASSHhpTl5oFVIeLB14f42VvnyLxRI00xr6LBax5eNBJU6AONvzMGDZTF8+caKblVBM99/TYZmpUZlp0+9yqke84dLw/fcJ253hOzbzQRIjpH41qQFeSBCA7F0l9eNkX65eRYQlZhLdyxUwUYFm5bIL96jQv69zfR5VWDB5liOyZPgBhPFiJwmKJ2D91Q32nON4Qk1+Mxx9s3NCzZhYgcQZK/XPWhRogaUet99svpIX+67mq9VMjUcSJCxA8Hiv+QOhp9fqI/MBdq3kxEqfl7dsOmJnFGC6VISAxB1PNrjRJNBANUWo9ec5XkqjSqVDan1upZ0RPECOksmH2TLJ17ixEHJGcHAh3XM1dW3j5f8lNSTANDS+B65ajr08jQSEOlU6Pnoo7ytF11tLg9VCPDR66aphFgvSm+o64OwolszcHnkH3zzyL1fM03+3FWtcAB8dVqcR95UwE+NP1yE2Hi2JbAXuTtny+ebPJr7QzKewcLTJVEtFCKhMQICKdMH+Y9WhQ0jQEqlMtGDJNxuT2kDnI6DYiIIENESK11y4kUYU/XbQetvr1UnGoga4cKtl7Fe9pIqtEnP5tykYnQWlZS55KoUfHinbutuki9p+G98k0XJcgNPxKtbfjxQRemAXm5VjSsx28+esxE6tFCKRISI/Agr9JopWk0RzAgc0aOiKqeC1FUtDKKFEEhBBRhUb+XqXJF3eXntP+qWBsZYo41yHd9o99UN0RauNEt6JE16+WpzZ+2uT2p25+0yOxDNI0IUzd0LXK2p4qgGZQiITECjRY7TpxoesDF6TItzaeL6joCWn4hEDTqoPEBUeCesjJZumu3PPjhxzJ/yTK56+VXNRRLCJ8BcYRfnobotdwxIHK0XpsWbohN72OjRtlPrlsvCzZuOu3217XrpKiqyjpXs4zvpCNQioTECAQpJ+rqww9pSNJSPKevw4sSPPjpKjoUb/+8cbPcsexVmfniIpnz/Ety39JX5FEV4sodO+WAFiVFozCTly8pGBaISLGpiI/oNKCRH35E2ruhXtXrFWlokB5JyabaIFrYJYeQGIFW2h+ueFM2oU5Ro8WMpCR5bf5cOVGvouwE4rVY7tXi4s/fXyWf7jtgdaFB+BdSOUAokIRGjz3S0mRARoYZ8rdi9x4TgUGQz8ydZfr72RswTumSo3J56tZbJFcFg2GD7QVR6581entBi7WRvooffeMOOd7GvZu0K6vkOxrVRroOPTrzRhmSlRl1dI3iPn6AWmucaQtGioTECDyY2ehYjQdTH9CK2trwJ2cOIsRan19u0qjw08OFVgduTScnI11mjh0jP512uTwxb44sv+M2eeHmmfKHq6fLnFEjrGjxSwq+L1PvCWkDvceimmpzr/gsmg10RIiAUiQkRqAvHfoWmojN7AiYOkZERGcKIrH73njTqn9DJOb3y8PXXS1L5s6W+yadL1P795O8FKv4iO49mEDBFE2/xKBRCX0ZjRQhNP2eNpccM30iobdot45CKRISI9Cl5vIB/a16MaDF3Re2bZeUcHGyPaAGsHktIKSKmWIKS4qt0SK+Rvmvq2fI+fn5ZjQJWrfRVQcdve1ycHWgJfZMaF5/erqpxJBX9FM8Lz/P+iHR16/v22/uN5qcn2m9LaVISIxA8S3Xk2wmKTAPuQrszZ27jNDw8J8OjDhpDARNpOS2Peh4va30eFNdHZ7iC/v0abXzNsCSAEWY3eYsiRFRX6oZwRPeoe8h69Oljs7ht44eZUSP4nOwoUGe2PLpSVOZtQW6IWGUCyLpjkIpEhJDMArlh5MnWi2iQMV4z2uvm4YDPLitSQL9C91Ol8xbvFTuXPaKCtbq9xjhpPP0M3TBaS1CQjonNIJ84J33wo0xsQc/CAPT09WO4ShZ87e+uMj0mWyOPd+IrjHhQ8+cHlaErcc/+cla2Xqs1EwS0ZZUcZ9Id+5Li+WB1R+ZH6S2jm8NSpGQGIKH/MI+veWyESMsMWok49Mo6PpnnpW3Dx40s+ek6YaJDiBCzB+YlZhoJou9csFz0qjRX2lVtdzw1N+koLLKNDr4Q0EZg3HMkTpC3ffwx2skOznJXAOt0ohEIYlMvdZ7hwpkzt+fN2nj2LNBo943+mQ2RbP696fvvC+flZY2rfAX2TCEz54r1IE+NG2qVV8aUuOrDL+3ZJks2PaZkWqabhjBgnvEZBDYh9UC3zl4SK7/27PmnHc1Ip+x4IWTfkjaC7vkEBJj8MBDUN945TU5dLTUGgeNh12F50lNlUm9802XGTzAmNX6w8NHpLwCU2GpUCAxleng/Dz549VXmsYbPLAQwa2LlsoxdFbGg68C6a+ivGXkcDOcD8MIzbRh+w7IsbIyc51e2dmfd26OcZcckKL5//2a9bLs063WdGmoQtB8ejR/iOLQCHSsttYIbuGc2SfN2IP7wxjo/1z5jtXhPPw9xHs8Mm1AfxmbmyMePQZDHDECBrMKVet31/Sd1dXL96dOkeuHDml1Qt3WoBQJOQugiIgGln/VaOkj9BXEg47IDaLBQ4u/eBJR5wfJ4cGGRBq8cvGIYfLgFVPNDDiRyRMgLywTcOtzL1rXUbGY41US5logEhlqZDpR5YBpv7754iITeUFOf5t7s5ml5hQpVkKKS1UwepwWu5+cP0d6JkcvRU3Z1AXevvQVOXz0qJUu8mPuNXwtzXOP1DR5YQ7mP/xcigAR9PqiEvnR6yus43GPAN8X7hX7cD0H7j/8neH+9fN/ueJyuW7oYDODTrTo1QghsQYywzRev55+ufz6xmulT2aGVZyOREcQWGSMNPbpZ3lpaXrsdUaIKGJGhAgQMWKyiCW3z5fxffpY54QbJ4wkgEZieZrOL665Uv776hlWlxwVczyKtIgCW8KIRv/q59ZxVvH385TbD87BPf/tpuvl7gsnSSKuh3vGZLImv/jrlzT9gbDdWhMYpYNZgFbcebtMGzbU2onzcTB+OCBJ8wOi+3Etf0CmDB4kS+/4mkwfNKBDQgSMFAk5y6AuLEEf6P3l5bKuqFh2HD9hRrmg03FWcpIMzcqSyb16mZEcqJNsq/iHOkYUzUv1/K1aNEfRF11fcpM9Miqnh5nRG0VMXAPuQMSKz5EWJNvSw9/e404HZq9BSzmugwgUdYUlNTVaZK4zUW66Sh1zL+Z6kkwre2tpIC+4R5y/qbhENh09ZqJZVBHEO12Sl+qR8T17ygW98k3kyzVaCPmKAlGgCwn+RlpgIaDIBKr4215wPq7V/DrN5WB9atHWg9/e41oDQvzj2vVSpBJEXsbn9TST6kLyyCM27I9s7UkD8S9W8MN9os+lmb1H9wVD+n2pVPGd4VpnCovPhHxBQFrol4ciJuoLseE19kUjRAAZIBrEudjwuqVoCXsiW1u097jWQAv4huJiWXvgoKzff1C2HTtu5I88QV7IH/7ifXvTwDcCqSJiRNEa3xcizkhn9c4QIqAUCSExwXSHQb2fbnGR+tKvAJQiIV0EFHkRjaGLizUjtdu8xj57cTgaUMzFNVBktYP96BOJuj78RT1p82NON6wvWpAmRIv0cH9Wn0yX2d+ZsE6RkBiBjthoCAHocB3NjNvgpPO1qFmDFtsWwBGQk0+PQQfv7cePy/HaOvMBGjIwnf/AjAyVlEhdOyaFwPXQEJTodpmx1Cv27pcBmRkyLjfHFHkhIzRmvLFvvxytqZXeaammXyE6naPuMElljM7UNzz/khSUV6BsL9OGDZHfTr/CFHebEynutwZki2vinj4rPSGHq6tMn8Zkd5z0S0+TsT1zTSdw7Iu22qElKEVCYgCE9t3X3jB1ZqjrwsP7i8suMXVh7QEdn3/27irTuRlVZT1TPGZFPrQk20GkhO1/Nm2RF7bvED/Wd9b3xoAAJweCkqzp3z1+nJk+DKv7Na9vjERhEGFDY0CW79snr+7eK3sLC01Xl8vHjZGfT7lYLxU0a5/8GLN4Q9JIB5fS81IzM+XvM2+U7yx/w0h6r8o50hfTo5Lsn47lWU+WFu5n5vChcl0LnaxxB5hAd7uK8Hdr1squ4hJzL1b/S/0Q6eJ6mvY5fXrLDydNNK3tqJc9EyhFQmIApIA1Q17SzfT10wf+2VvnagQV32IDiB1Eh5jq67ZnnrUWgvd55c7Jk+TrY0eftOAV0sBojntfe93qo4h0jATRuVn/QhyQVkSSGqVlZ2XJMzfdYD6LCApFX0RZ7xccVhHukb0HD5nrJGRny7zRI+W5bds12uwhj117pRlxc6vmKycnR35/9XQZoiJEBDzrxUUmKv3tjCvkpieetvJt5IVMKEirpftWgc2bcK7cc965pgElAs5C522sl/36lk+tETG4nrk3XCt8EO4N+7FPZf/tKRfJHWPHdLiPItCrEUI6G0RAN48YbqIY8+DqE/yKCgf1c6cDsnt6K4bGJei5llhuHzvKFDMjQGRYg+VezFIN2UCIKpX+WZlyj0ZM90+/XH56xVSZN/4cSfckW1GdiuVEVZXcsnCJYAYePPwomm4oKZFZf31KHnlvlRRW18jNev5fb58vy+fP1ejrAsnzpJiuNcgXBIlo7akbr5PsxCSztCii2crycjkvP7z+DNLCZpcgXkf2n7S1vBIh1oT+3htvyutYwB9zLIaPuXr4MPnx1EvlfpXvfRq5TurXz1zDyDc5Sf6y+iN55tNtJlLvKIwUCYkRmSqhb726XHZhfRSVj9Ppkg/uur3N5QgQ/GCar2ufe0n8kKDK4DwtGj5y1XSzaD5AURfR5DULngufoY+wvv/dVTNkYu9eKs9GM64Yn7hVqnGa7uNY3GnNunDk2SiTBvaX38yYZiIqiHrprl3y2DurJEfF9sq8W0xa6P6CaO1Hb70r6wuLZfu935LLnn5WEuNcRpiIZtHles7CpXJUxbr07rs0byIbS46Ze//1hx9JEcYjqxDH98qXO88ZZ2bzsYOhg71SPGbd6kgEDaGhOmDBuvVWhKh5nKo/MD+75CJTxEcxG53K8T0g75gS7ZuvvCa1+F7xA6TR51NzZpsJaztSx8hIkZAYgSLpbWNGWRGRPsBBfWgx2QMe7NbAZx8eLhQ/li7QczCW9zYUm20ygTR+/v4HVlESFgoGZNmtc2RMbo4RLhpTII4G3VC0hfi+d/4EmaebGQ6nUeWafQdkt0aaaJlGVDtv1Ch55JZZUlpyVH616sOmlmR4ykyKa+rpHKauEyvu3bt8pVkd8NI//kmOqvT/j0aOOA4dqjH11+Te+SayNBdQQWP0yiQVIyaQtW8TdZ9diJA9rr9gbViIet9XjBwhD06bau4JfRMjI3QQOePe0hPjZbFK0OkOp6d5/+0n60xeOwKlSEiMQKR1cd++4kB0hoc1zm0aQ9B62xoQyYKt21Rc1kw6mEVnQl6eXsuKeCCNEhXmetT7hWX13ckTzcQL9uJ1cyCa70wYL/FJ4TVjNIJE6zGK4QCywTC5sYMHyfLde42PAVRlBIlRIyrfi/r2kYbyCll96JBZhGra2DHyzNdulUkqQtR34vjI0ER7Z+pI53J81nyz17Hi/h9HPax+V9Z3Fif3azEZLc+tdc7Gd4M8fnfCudYPkH6/WzV/+HEI30ZUUIqExAg8wiji3YTJDCAsFdCGAwel2uc1+5sD4RXX1Mq+ohIT7aCubJYWG+0ygMTQRcYIA8QnyJxRI02rMD5rbUME6omLlyn9+5o6QeRl7ZGikzpVIwIb3SNHQ1yNUkMRK4YkCfJV2WDlwKsGDZQfXzld1n77G1rMniM/U2FhlcD2dPU5HUgRxd13DxWY/OE7u33cGPMjgrWsW7qvyIZi/OyRw5vqHmH1LRr1dqTTOKVISAxBHdrc0SNPeliX7NzdYoML+uK9uGOHieIMGp3drA+6PQKEHD46UmhJQ4XVOz1VPtbi9lsq23c1emxrW753r56iMoV9NB9FKmBXZEadMOhP2RQmhkGRGIZHRIcJK6YPHCAlei6KruivGO2UYq2BZRd2l5dJsL4hnAeHCs8tr+3Z2+L92Le39f4/KDgsTqxqCHB/GlE7m91fe2BDCyExBjO3zFm0RIowcSzep3hk0ZzZp/RZRF3hNc+9IA3oXqMSHZ2fJ49ec9VJHZ5xrUufXiABLXY2dUWx1TeeFsgUQtbzmjf8oOj6/7TounD9BnnnO9+WmkafqSf8/doNskz3ffyDfzDF8PaQkZgg31j2quw7UaZphWTK4IHyq8umtNmHELNoQ+4PvbvKankH+C4g6vaCagcIVb+z72sUe8PQISYCjgZGioTEmFqVyx1jx1oPuIrsRHmlWXMk0pgBULxdX1wsDWitxUOtRVUs4ORt9kCj2B2AxEwkpUCOEGN7NwgU59fVm1EordXTfRHg3sxi+Wg8Asgb1nhp6T5a2zR6Nfen0Wau/oB05P4YKRISY/CIo27rmmdf1KBHH1wV2aWDB8mvpk5pihYRWWEd582FRUacDj1+9Z1fP6X7DjpIX/jY41bLrApz/rnnyPVDBkcdDeGhh4jtM29/0ZEixmqjj+HT6zeaBhZ0J3r82muM/02xPwpwT3kpKeF30cFIkZAYg8c50R0nVwwMrwGtxddVu/eYyAjCNBGSRm5GiCjequBmDR8u3sCpojNywLT+YUfUafTZNz1N8lNTo9p66dZ8KYIvGgzCwWziJkJU/I1+ydYfgd7N8t6erU9aqrlGR6AUCTkLoJ8hhp+ZIrTBIQu37zQNLhhvvHzPPkuYQJ0wa8Qwa/mAZqAhZFBWlh6jEadGlFuOHTNSRatttFt7hYhIrcnCMQQt6MOzcW/htDSq3FtWZlJuKf9tbx3PL6VIyFkAD+rAzAzJ65lj1X1pUXHprj2mWI2uMs9jOJsWGfHZ4LyeZmKDlqSFPnmT+/TSC1oNLQePHZfCqmrTnScm6GVNvaYLreXRicZ+dHtyh++of0Z6Ux9N0ej6Zf2OTCfwswilSMhZAv385o4cafofQmgFGuVhiNpnpcelpjK89KhGR5j4oaUoEfi0SD1j0MDPoyk95fGNm82wuvYAOaHfH0TTHlGhgG/GJqu8o1EisofhheYkTahK7wujZ9oCh6boD8RFpi8lqhlcsmrfPjO22t4o1RY4DnMtou9iR6EUCTlLoDEEy26aLjFAH1xEiy9u32FFiTBJQrxc1r+fGenREigWYmaa8wb00zcqTr3WO1oMX7H/gGncaEt0kFKPpCT54cq35Z/ffte0Pscqwgxo8X5ApkZ9KObrfW4uKjb31FJ69j3o9/iDC8637g3oufe89oZpFMLWFujSdLiqSqY/8bR8qj84mNOxI1CKhJwlEAmhDvHiAf2bhLZoxy7T6djMpqOR5DXhpTxxbGtgSN6/XzpFbaI6gUiTEuWXK9+Sv2/dbob7YcwvBAIJInJCnSUiSfR3nL9kmWw7csQME7zmuRdN9GqXEuon7YnjJZLAi2gEioWkLurd+3O5qRAhYtw/5A2BQVqYcALVBJEr4zUmcphz3nire43mHzP7zF201AxvxES2ZoSL7sf9YS0YRL2Zes1X9uyVexYvMyL98bJX5Yktn5q+j9Himv+Nb/4i/JoQEmPQb653WoosD9chojUZdWkGf6P8VGWXGOdus38dPkH3lXN75csKXEclgW3DwYOyeO9+M3sN1rkL6IEYdbKp5Kg8tmGj/PdHn0gFRosgKlVZDcjOlpkjhjWNSElVQS3fs18OnCiTOyecK75gwCxRerCyUrZoJHrD2LFGQu3p+4djUIf6/K69EkQrusqpqLxCntH8btT8fFJYJK/v22/mnCytq5Up/fo1TSGGiHKqRssbSo/L0bIyU8dYr0JfuvUz2XT8hDkOxXqM9MFM4yv0Or9ctVre3bnbapkHjX6ZOXaMaYWOtoWd/RQJOcukxSfILYsWy/EqzJIdLqypCHqpRBbdMrvdfQEREWJ6/u9jklkUtyNFcERnEExEBhpRQUpmQ6tsQ71cPGJ40yL7WEsFUdtOFc63Fy6Wq8eMloemX25m6MZSorW+Rpn21ALp3yNLnrzhWiMkTAh7OjkiWj2s0vr2S4usxhOkj3NM3vQAhIea1xvHjZF/nHjBScst4KNMjQr/7f0P5B2IH3WmuA/cJzbTuqwboldzf/rDgE7fuIam87urrzRLI3RkFm5KkZCzTLJGdQt37pI/ffiJyiLcsqoP709UUtO1aI0pv9oLisZ+DQkfWbtOVu7ao8KwojIjCqMWfbzxhGNkiBZpPRo5/ctFF8ql/fua4jSEiL9/3rhZ3tu+U8WqcoFcQVh6Dr1WCHmCYPSzGVrEv0NFBmmdTowo6h7VYu+/q9z2YV5JCNEUw3XDuSrFmRPGy/cvOP+kmbcBjsJyBKsLjsh/rv5YaqqrrPvChmtgwzXMdTR/KsWpQ4eYiXHR2NLWrEFtQSkS8gWA+jB0dTF1eArkgsWimorSUYBroI4OxeYPDh+WNVo0PaRFXhPp6WeYxGFUj2y5qE9fmdQn37RsYxovEK/5WFVwWJbs2m06TkOlyEHzESRIAzlFURSjcC7u01tuGTWi6TptgXuNNIIgGi2tqzd9EiE8rNsyMCPd3H9rIkJLMuoit2txelVBgWw9dty0SKOYjcYiLJw1uXdvubhvb8lL8Zj8nU7WbUEpEvIFERFihDN5kAGuhzo/dIUxEgtfHpeFbBtVIljxrzkQI6QTDZBhe4RoB4KGICP3DfFCsshbe+4c50KQmE3HPjwa18F94f6irT9sCUqREEJsIFomhBAShlIkhBAblCIhhNigFAkhxAalSAghNihFQgixQSkSQogNSpEQQmxQioQQYoNSJIQQG5QiIYTYoBQJIcQGpUgIITYoRUIIsUEpEkKIDUqREEJsUIqEEGKDUiSEEBuUIiGE2KAUCSHEBqVICCE2KEVCCLFBKRJCiA1KkRBCbFCKhBBig1IkhBAblCIhhNigFAkhxAalSAghNihFQgixQSkSQogNSpEQQmxQioQQYoNSJIQQG5QiIYTYoBQJIcQGpUgIITYoRUIIsUEpEkKIDUqREEJsUIqEEGKDUiSEEBuUIiGE2KAUCSHEBqVICCE2KEVCCLFBKRJCiA1KkRBCbFCKhBBig1IkhBAblCIhhNigFAkhxAalSAghNihFQgixQSkSQogNSpEQQmxQioQQYoNSJIQQG5QiIYTYoBQJIcQGpUgIITYoRUIIsUEpEkKIDUqREEJsUIqEEGKDUiSEEBuUIiGE2KAUCSHEBqVICCE2KEVCCLFBKRJCiA1KkRBCbFCKhBBig1IkhBAblCIhhNigFAkhxAalSAghNihFQgixQSkSQogNSpEQQmxQioQQYoNSJIQQG5QiIYTYoBQJIcSG4+X3PwiFXxNCujlGBk6nBOPcEnK5zCZOh5pCt1BIHMGgSCAojkBAnI1+EX2vn0SNJR1Nx6HpiKbjcOpfxGi4mqYjet0Qrq3phDQdvMcpZwFKkZBuDgQA+QWTEiSYkCAJJaWStvkzSTp4RJILiiTuRKU4Ghv1s3hp7JEl9X3zpG5wf6kcP1oaszPE2dAgrgavJUvrki1i0lHxBZyajiNR4gNlklm/Q1K9hyS5sVgSAxXiDHr1szjxujOkLi5fauL7SnnSKGlw91A5+sSln0OUsRQkpUhIN8VISiPCgCdZEguPSv4Lr0ru8nclufSISsdvBCaI4oyCbBGcbojcghIntb0HyNEbZ0jJ7KvE2zNb3FW1Joq0S8uSoUsaXR5J8h+XPpVvSr/KFZLiO2iiQKSDSBGRI1JwmDMikSLScUutyrEwbaocyrhB6uNyxR2o08/8J6XTWVCKhHRDQlpEbkxPFc+egzL0gT9K9qY1YRUlGIFZEmxLOZbqELW5pMGIq/TSy2Tv/d8Tby7kWKNSC5kjGp0pkqgyHH3sMeld/Z4Rod+Z+Hk6KJq3hl6jKR2NEnF8ScpFsq3n9zSK7K3RpqajqXcmlCIh3QgjPi0mOxoDMvQ//iB931gkjZKqWonXTzra7mqJyyle1ZxXDt0y38jRUR+QkN+pMnxUhp54VovNiRJwJIQl2JZw20CjR5cWo+OCNbI3a55sy/lfJsp0hVCs7hwoRUK6CXjQ/Wkpkr7xMznn7p+owGo1/vLo3s7SCUDMWCO1yf1lz5M/lHODv5OUmkMaLaaGZdhJaATpDtaKz5Uun/R9UMoTRxpRdkYK7JJDSDcAQmzMzjT1hufffY/KIxADIVrxok8yJC29QKYuuVs8hwvEl5Sh0VznpgPB+l0ejRAbZOqBb0mfqrdUkJpO+OMzgVIkpIsTEeLA//tXGf3gA1pcTtd9bt3b2UK0pJg0pFpSZ1eJaEnZvb5K3AU1InGxUI1DZRtnosWJhT/XIvqCThEjpUhIFwaC8KenSp+nFsrgJ/6sUVy27onNY4/mkMR+tZI6vUK0BG2RqD7cWi6u4loJuTs5WozgcIrXlSnjjv5B+le8ahp2zkSMlCIhXZhgUqKkbdwmI3/zkIkQOzs6jAAJuZL8knZNmUiDtc+A5OJE4jeXiaPOL6FYGceIMUMmFP1K0rz7JehAw1HHoBQJ6aKg243T1yjjv/lj08IcuwgRm1OyZh8VDUWtHXYgRpeWptfo55qnM4ni2kTF2OhKlYsL/lHfoDtQx+6XUiSkCwLxNGakytBfPKI+qtf36BPY+USEmDKhQhwefddal0E1jaMhJO49WrR2x047IYdb4gNVMuboY+JTQXZEwJQiIV0QjFRJ2bVfer/1igQkWffEqD5PccX5Jfm8ahH0rW4LLUbH7a8Wh1eL0THLjkP8To8MLl8oKd4ClSIalKKDUiSki4HoCEP3Bv/Xn0R1pe9iJ0REiZ7JGv21JyQLZ8O9O7bRoumu40yU0aV6/66kqKNFSpGQLgYmd0goPiY9NqzW0mxCeG/nA9lgiF3iiHotq1v7TouW4t1Ferw/GLWsoiHgSJReVe9Jor/MiDsaKEVCuhgYxtfrhVdVBpExzLEBXXCShtVEn4Ta0FVUq//FLm9m9IzDKX0rV5jhhdFAKRLShUD0FXK7Jfe192IeJYKEIYj6wm/aAzyo1nGV1FniiiF+jRb7VL1pBh5GE5VSioR0JVxOMx9i0rEjKoLYtDhHwBRfcbm+1lucW0Ot46zEeeg2EztCDpek+ArMdGXRFKEpRUK6EEGNElN27NUHGx0GYxuJudI0RETJtANmc2j2nHV6fkyz6DDTjaV6DxhBthdKkZAuBBpZkg4c0VewTSyN45C4Hh2IEgGypeZxIFqMZRHaXNshKY2FUUXNlCIhXQktPicVlkQlgY6A4NCZHOhQlBjB6dXzY+ltBd9Dsq+YkSIh3RVM0eUuq1QZxNg2iiPxDKSI7PnPghT1+4gPVET1fVCKhHQlVALOgMrmbEjxTO1hlhqINfp9mNUAKUVCuicqmkACZoiJvXBC/jMUr1P1E/Ns6vdh+im2PyFKkZAuBNZl9vXM1riocxdzaomg19XxgFQdFYqPbb0nwIqADe6sqL4PSpGQLoQjEJT6vr1UAihCxw64MFipUuuoQSDFJD0/xpEivofaOP0+Qu3/PihFQroQDn/ALFRvaSuWxglJY2kHR8yEsxVM1WJ+LOsVzbUdUpPQT0VHKRLSLXEE/FI3ZIAqIEnfxTYMC2jxOVSt8o22CK3ZCiVii3WkGDRLE1TH92ekSEi3JRgSX2aaVI0ZpQ93e6eu6SgOaSxWu0VbNagiDGaptNU+Ha2SbA9odS5PGiWNrhR91377UoqEdCEgGVeDV4pnX6Wuqrd2xgCkg7HP9TuSJap5XOEmDdoCvTzmbyxxB+vlcLp+D8HoFsqnFAnpYji9Xim96jLxm3VZYmmekHhLkiUE97bXOpBiguYqRyNFjWpjhhaXsRxBUeql4gphHHj7oRQJ6WqobALJiVI478ZwtBgb+VgeDEndxjSR9iyeh2z4RRoH6vH6JproLTpCJko8kDErvKpfdPdPKRLSxYBs3DW1sv9/f0tf4RGPXZ9FFKHrtmlE2p5oEW5SR/n76/H+WEaJQZVhnOzKuUvlWBe1fClFQrogDsxV6HLJ7h/9QOKkWvfELlpEzFf1XpaYBu/WQPKNIr7R2XqSI2pRtZtQSOID1bK1530qRremE/0PAqVISBfFVVMnhV+fJeVDxmsxGivUx0qMIak/7BHfvgSzYt8pINmAxqu58RLolayvYxUlhsQVqpdjKedr0XmmiRI7AqVISBcF0Zirula2PP2wOilR30ezbkD7QTpOjcgqV+ZIqF7fNe+io8FaKN4h3vNyNVQMmuNjgTPYKH6HRz7p/aDEBas7nA6lSEgXBjPmoBi9btlf9GFH15TYiRGRWtnCnlYVZsQs4dfeyXn6InaNK44Q+mQG5f0Bj+sbp5F0R6EUCeniuLw+aejVU9Yv+ItKyWc2q0zbuUB4Qa9bTjyvAkTfRSShW8PF+RJKcImj455qg5BGiD5xqhQhxPq4nlF3wWkOpUhIN8BdVy81wwfKx2+8JIGEFC3hor4tFmIMSbDBJeV/SRd/KEH8U9NViE7T8NPphELiDtSKz5UuKwe/JDXx/cVtOk2eGZQiId0Ed12D+NNT5KMPXpTjF14icVKpEkOxs7OEheKxT+KlQo7cNEdevvdj2Z99syT4yk0016npaGQYH6iUorTL5c3Bz5mhfO4QGpPOHMfL738QA4UTQr6shJxOacxMk+x3PpaRP3lQEhtKxC8eVQ2ajjtS6wcZNpquP1X5I2TXAz+SionniLu8ShqdadKjbrOcU/JbyajfqfJKNX0IO7RglUaGKCa7g7VaTM6TDfn/KsdSJpouOJ05fySlSEg3BA99MDFBAp4kyVuyUvr+5XnJKNgmAY3zsIi+tfBVW+JCK3JAj/Ka15VDzpED379DTky/RFxV1eL0NZqzTTqOeJWjR/JrVsuw488YSaIPIfYHzYJStgJr5KQmEBVqOiGvEWJ50mjZm3WrHE6/0oxacer+jmi8LRzL3lsVcnTE2oSQrzxGWkmJEoxzi2fPQclZuUpyXl8lyYVHVFUQDiIwHIUNnkCtoct08akZMlCOXzlFjl1zmTT0yVcR+sTZgIacU7HkqBLWKNHTWCy9qt+X/OpVZk1md7ChhXTwStNxJkhNfB8pSp0qxamX6OsBKkm/ShLndD4hjUYdr6xaHQoG1foUIyHdFqMjt0ZvCRq9JcaLu6ZOEo4US0Jpmbhq68WBrj36uV8jS19uD6nvl6/HJpjJJ5xeFaE/0C5JWdpzSdAZr4JMMDPYJKskE/wnJM4MyfObz/3OJPG6s6VWi8kBjTIREbqCEK4/JjIEEKLT5RLH22vXhapr68SJRWQIId0eiAt1fiGXOkG9gGVCIzhUHIIgKqAbXp8hqI1UFWka8I9ddyg2o4huRZBnI2RDcJjqUQFnpKZKsBNujhDSNYCAIDynRn+oG0Q/x8iG99jfGUIElhJRZ6jphDSNpk3T0f34/GwIEcCDGakp4szvkS0BNSRCR0II6a4EAgHJy86GFHtInJajCSGku4KgMM7tll45Pay28KH9+orP72e0SAjplvga/TJiAFZBDHcQGjVooCQlJLBukRDS7UD1YWJCvAy3SxFMu+B88fsDpgWGEEK6A/CdX0vJMyZdEN5jkyJMOW2iilEPQoUji9KEkK4K/AbP+XWbrkJMiP98kRmHfniS/RrVmu+sXS/VdXWm4hGdutmxmxDSFYDusKENJT0lRS4//zzjOTunSDHC/iOFsvNQgdTW14vL6WySI/VICPkqYQSnmkObCeoPkxMTZfTgQTIgHxPfnkqrUoxQWV0jxyrKpaqmVrxenyleM3AkhHwVgN3cGtSheJyakix5WdmSluIJf9oSIv8fpH8i3NqmfLMAAAAASUVORK5CYII='

  /* Since this is a simple query with no additional business
     logic involved, it bypasses application's core completely 
     and retrieves cards directly from a repository.
   */
  async handle(
    query: DisplayCardQuery,
  ): Promise<Result<string, CardNotUnlockedError | CardNotFoundError>> {
    try {
      const card = await this.cardRepo.findCurrentOneByEmployeeIdOrThrow(
        query.employeeId,
      )
      if (query.emptyCardDesign) {
        return Result.ok(this.emptyCardImage)
      } else {
        if (card.lockStatus !== LockStatus.UNLOCK) {
          return Result.err(new CardNotUnlockedError())
        }
        return this.baas.displayCard(card.externalId)
      }
    } catch (e) {
      if (e instanceof NotFoundException) {
        return Result.err(new CardNotFoundError())
      }
      throw e
    }
  }
}
